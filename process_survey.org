#+title: data steward survey 2021
#+author: Ilja Kocken

# this sets the properties for all R source code blocks, so they are all related to the session
#+property: header-args:R  :session *R:survey* :exports both :results output :eval no-export

* TOC
:PROPERTIES:
:TOC:      :include all :depth 2
:END:
:CONTENTS:
- [[#toc][TOC]]
- [[#requirements][requirements]]
- [[#read-in-the-data][read in the data]]
- [[#quick-exploratory-plots][quick exploratory plots]]
  - [[#plot-the-answers-to-a-single-select-question][plot the answers to a single-select question]]
  - [[#plot-the-answer-to-a-multi-select-question][plot the answer to a multi-select question]]
- [[#tidy-the-data][tidy the data]]
  - [[#tidy-up-all-multiselect-answers-so-they-can-be-split-up-if-desired][tidy up all multiselect answers so they can be split up if desired]]
  - [[#replace-na-with-hard-coded-na-for-nicer-sankey-diagrams][replace NA with hard coded "N/A" for nicer sankey diagrams]]
  - [[#clean-up-research-guidelines][clean up research guidelines]]
- [[#bar-graphs-for-the-whole-report][bar graphs for the whole report]]
  - [[#data-types][Data Types]]
  - [[#data-collection][Data Collection]]
  - [[#data-re-use][Data Re-use]]
  - [[#data-storage][Data Storage]]
  - [[#data-backup][Data Backup]]
  - [[#file-structure][File Structure]]
  - [[#fair-application][FAIR Application]]
  - [[#storage][Storage]]
  - [[#open-data-formats][Open Data Formats]]
  - [[#conversion][Conversion]]
  - [[#project-replication][Project Replication]]
  - [[#metadata-provided][Metadata Provided]]
  - [[#skip-code][Skip Code]]
  - [[#versioning][Versioning]]
  - [[#publication-location][Publication location]]
  - [[#code-license][Code License]]
  - [[#code-doi][Code DOI]]
  - [[#personal-data-bool][Personal Data Bool]]
  - [[#gdpr-work][GDPR Work]]
  - [[#privacy-review-dpia][Privacy Review DPIA]]
  - [[#personal-training][Personal Training]]
  - [[#finding-privacy][Finding Privacy]]
  - [[#neg-consequences][Neg Consequences]]
  - [[#ethic-considerations][Ethic Considerations]]
  - [[#research-guidelines][Research Guidelines]]
  - [[#resources-for-rdm][Resources for RDM]]
  - [[#user-data-mgmt][User Data Mgmt]]
  - [[#any-questions][Any Questions]]
  - [[#contact][Contact]]
  - [[#q36][Q36]]
- [[#try-out-sankey-diagrams][try out sankey diagrams]]
  - [[#data-types-and-collection][data types and collection]]
  - [[#open-data][open data]]
  - [[#code-and-versioning][code and versioning]]
  - [[#fair-and-storage-grouped-by-level][FAIR and storage, grouped by level]]
  - [[#fair-and-code--share-location--code-license--doi-by-level][FAIR and code + share location + code license + DOI by level]]
:END:

* requirements
This document is written in [[https://www.gnu.org/software/emacs/][emacs']] [[https://orgmode.org/][org-mode]], and is a [[https://en.wikipedia.org/wiki/Literate_programming][literate programme]].

We use a recent (>4.0.0) version of R with many packages in the tidyverse, most importantly ggplot2.

The ggsankey development package is installed from github.

We also tried out ggalluvial, but did not like it as much as the sankey graphs.

We use tidylog in some cases to make sure the transformations are doing what we hope they do. Commands that use this package are prepended with ~tidylog::.~

#+begin_src R
  # install.packages("tidyverse")
  library(tidyverse)

  #remotes::install_github("davidsjoberg/ggsankey")
  library(ggsankey)
  # install.packages("ggalluvial")
  ## library(ggalluvial)
  # install.packages("tidylog")
#+end_src

* read in the data
#+begin_src R :results none
  raw <- read_csv("dat/2021 Earth Sciences Data Steward Survey_November 29, 2021_03.23.csv",
                  trim_ws = TRUE, col_names = TRUE)
  dat <- raw |>
    tidylog::filter(StartDate != "Start Date") |>
    tidylog::filter(!stringr::str_detect(StartDate, "[{]")) |>
    type_convert(col_types = "TTccidcT?????????????????????????????????????????????????????????????") |>
    tidylog::mutate(Finished = ifelse(Finished == "True", TRUE, FALSE),
                    Consent = ifelse(Consent == "Yes", TRUE, FALSE))

  glimpse(dat)
#+end_src

* quick exploratory plots
** plot the answers to a single-select question
#+begin_src R :results output graphics file :file imgs/contact.png :width 600 :height 200
  dat |>
    ggplot(aes(y=Contact)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/contact.png]]

** plot the answer to a multi-select question
#+begin_src R :results output graphics file :file imgs/data_collection.png :width 600 :height 200
  dat |>
    # in this case one of the options has a comma, so we cannot split by , automatically :(
    mutate(`Data Collection` = str_replace(`Data Collection`,
                                           fixed("Measurements from a machine (e.g. camera, spectrometer, GPS/GNSS device, etc)"), "Measurements from a machine")) |>
    # this splits the multiple awnswers and puts them all in their own row, copying over the rest of the columns
    separate_rows(`Data Collection`, sep = ",") |>
    ggplot(aes(y = `Data Collection`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/data_collection.png]]

* tidy the data
** tidy up all multiselect answers so they can be split up if desired
inspect all unique values in a variable
#+begin_src R :results none
  dat |> distinct(`Data Types`)
#+end_src

Tidy up the multiselect answers (remove parentheses and commas)
#+begin_src R :results none
  dat <-
    dat |>
    # get rid of examples
    tidylog::mutate(`Data Types` = str_replace_all(`Data Types`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Data Collection` = str_replace_all(`Data Collection`, "machine ,", "machine,")) |>
    tidylog::mutate(`Data Collection` = str_replace_all(`Data Collection`, "\\(.*\\)", "")) |>
    # this has Yes, answers everywhere, just replace the , with a :
    tidylog::mutate(`Data Re-use` = str_replace_all(`Data Re-use`, "Yes,", "Yes:")) |>
    tidylog::mutate(`Data Backup` = str_replace_all(`Data Backup`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Open Data Formats` = str_replace_all(`Open Data Formats`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Open Data Formats` = str_replace_all(`Open Data Formats`, ", I use", "; I use")) |>
    tidylog::mutate(`Metadata Provided` = str_replace_all(`Metadata Provided`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Skip Code` = str_replace_all(`Skip Code`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Skip Code` = str_replace_all(`Skip Code`, ",", ":")) |>
    tidylog::mutate(`Code License` = str_replace_all(`Code License`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Code License` = str_replace_all(`Code License`, "Yes,", "Yes:")) |>
    tidylog::mutate(`Versioning` = str_replace_all(`Versioning`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Versioning` = str_replace_all(`Versioning`, "Yes,", "Yes:")) |>
    tidylog::mutate(`Versioning` = str_replace_all(`Versioning`, "No,", "No:")) |>
    tidylog::mutate(`Storage` = str_replace_all(`Storage`, ", namely", "; namely")) |>
    # personal data section skipped, no answers on my end
    tidylog::mutate(`Research Guidelines` = str_replace_all(`Research Guidelines`, "\\(.*\\)", "")) |>
    tidylog::mutate(`Research Guidelines` = str_replace_all(`Research Guidelines`, "Yes,", "Yes:")) |>
    tidylog::mutate(`Research Guidelines` = str_replace_all(`Research Guidelines`, "No,", "No: "))
#+end_src

Doing the actual split results in way too many rows, messing up the counts.
Thus it needs to be done separately for each plot?

** replace NA with hard coded "N/A" for nicer sankey diagrams
#+begin_src R :results none
   dat <- dat |>
    tidylog::mutate(across(.cols = where(~ is.character(.x)), .fns = ~ replace(.x, is.na(.x), "N/A")))
#+end_src

** clean up research guidelines
Turns out we messed this question up a bit
#+begin_src R :results none
  distinct(dat, `Research Guidelines`)
#+end_src

#+begin_src R :results none
  dat <- dat |>
    mutate(`Research Guidelines` = `Research Guidelines` |>
             str_replace_all("specific ", "specific") |>
             str_replace_all("^No$", "No: I don't know any guidelines") |>
             str_replace_all("^I don't know any guidelines", "No: I don't know any guidelines") |>
             str_replace_all(",I don't know any guidelines", ",No: I don't know any guidelines"))
  dat |>
    distinct(`Research Guidelines`)
#+end_src

* bar graphs for the whole report
headings marked with NEXT are not included here because a bar graph wouldn't be the best visualization there.
*** Data Types
#+begin_src R :results output graphics file :file imgs/data_types.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Data Types`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/data_types.png]]

*** Data Collection
#+begin_src R :results output graphics file :file imgs/Data Collection.png :width 600 :height 200
  dat |>
    separate_rows(`Data Collection`, sep = ",") |>
    ggplot(aes(y=`Data Collection`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Data Collection.png]]

*** Data Re-use
#+begin_src R :results output graphics file :file imgs/Data Re-use.png :width 600 :height 200
  dat |>
    separate_rows(`Data Re-use`, sep = ",") |>
    ggplot(aes(y=`Data Re-use`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Data Re-use.png]]

*** Data Storage
#+begin_src R :results output graphics file :file imgs/Data Storage.png :width 600 :height 200
  dat |>
    separate_rows(`Data Storage`, sep = ",") |>
    ggplot(aes(y=`Data Storage`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Data Storage.png]]

*** Data Backup
#+begin_src R :results output graphics file :file imgs/Data Backup.png :width 600 :height 200
  dat |>
    separate_rows(`Data Backup`, sep = ",") |>
    ggplot(aes(y=`Data Backup`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Data Backup.png]]

*** File Structure
#+begin_src R :results output graphics file :file imgs/File Structure.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`File Structure`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/File Structure.png]]

*** FAIR Application
#+begin_src R :results output graphics file :file imgs/FAIR Application.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`FAIR Application`, fill = Contact)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/FAIR Application.png]]

*** Storage
#+begin_src R :results output graphics file :file imgs/Storage.png :width 600 :height 200
  dat |>
    separate_rows(`Storage`, sep = ",") |>
    ggplot(aes(y=`Storage`, fill = Contact)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Storage.png]]

*** Open Data Formats
#+begin_src R :results output graphics file :file imgs/Open Data Formats.png :width 600 :height 200
  dat |>
    separate_rows(`Open Data Formats`, sep = ",") |>
    ggplot(aes(y=`Open Data Formats`, fill = Contact)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Open Data Formats.png]]

*** Conversion
#+begin_src R :results output graphics file :file imgs/Conversion.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Conversion`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Conversion.png]]

*** Project Replication
#+begin_src R :results output graphics file :file imgs/Project Replication.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Project Replication`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Project Replication.png]]

*** Metadata Provided
#+begin_src R :results output graphics file :file imgs/Metadata Provided.png :width 600 :height 200
  dat |>
    separate_rows(`Metadata Provided`, sep = ",") |>
    ggplot(aes(y=`Metadata Provided`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Metadata Provided.png]]

*** Skip Code
#+begin_src R :results output graphics file :file imgs/Skip Code.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Skip Code`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Skip Code.png]]

*** Versioning
#+begin_src R :results output graphics file :file imgs/Versioning.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Versioning`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Versioning.png]]

*** Publication location
#+begin_src R :results output graphics file :file imgs/Publication location.png :width 600 :height 200
  dat |>
    separate_rows(`Publication location`, sep = ",") |>
    ggplot(aes(y=`Publication location`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Publication location.png]]

*** Code License
#+begin_src R :results output graphics file :file imgs/Code License.png :width 600 :height 200
  dat |>
    separate_rows(`Code License`, sep = ",") |>
    ggplot(aes(y=`Code License`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Code License.png]]

*** Code DOI
#+begin_src R :results output graphics file :file imgs/Code DOI.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Code DOI`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Code DOI.png]]

*** Personal Data Bool
#+begin_src R :results output graphics file :file imgs/Personal Data Bool.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Personal Data Bool`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Personal Data Bool.png]]

*** GDPR Work
#+begin_src R :results output graphics file :file imgs/GDPR Work.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`GDPR Work`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/GDPR Work.png]]

*** NEXT Privacy Review DPIA
*** NEXT Personal Training
*** NEXT Finding Privacy
*** NEXT Neg Consequences
*** NEXT Ethic Considerations

*** Research Guidelines
#+begin_src R :results output graphics file :file imgs/Research Guidelines.png :width 600 :height 200
  dat |>
    separate_rows(`Research Guidelines`, sep = ",") |>
    ggplot(aes(y=`Research Guidelines`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Research Guidelines.png]]

*** Resources for RDM
#+begin_src R :results output graphics file :file imgs/Resources for RDM.png :width 600 :height 200
  dat |>
    separate_rows(`Resources for RDM`, sep = ",") |>
    ggplot(aes(y=`Resources for RDM`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Resources for RDM.png]]

*** NEXT User Data Mgmt
*** NEXT Any Questions
*** Contact
#+begin_src R :results output graphics file :file imgs/Contact.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Contact`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Contact.png]]

*** Q36
contact me?
#+begin_src R :results output graphics file :file imgs/Q36.png :width 600 :height 200
  dat |>
    ggplot(aes(y=`Q36`)) +
    geom_bar()
#+end_src

#+RESULTS:
[[file:imgs/Q36.png]]

* try out sankey diagrams
** data types and collection
#+begin_src R :results output graphics file :file imgs/sankey_data.png :width 1000
  dat |>
    separate_rows(`Data Collection`, `Data Types`, sep = ",") |>
    make_long(`Data Types`, `Data Collection`) |>
    ggplot(aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node))) +
    geom_sankey(flow.alpha = .6) +
    geom_sankey_text(aes(label = node), hjust = 0) +
    theme_sankey() +
    theme(legend.pos = "none", axis.title.x = element_blank())
#+end_src

#+RESULTS:
[[file:imgs/sankey_data.png]]

** open data
#+begin_src R :results output graphics file :file imgs/sankey_open_data.png :width 800
  dat |>
    separate_rows(`Open Data Formats`, `Conversion`, sep = ",") |>
    make_long(`Open Data Formats`, `Conversion`) |>
    ggplot(aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node))) +
    geom_sankey(flow.alpha = 0.6) +
    geom_sankey_text(aes(label = node), hjust = 0) +
    theme_sankey() +
    theme(legend.pos = "none", axis.title.x = element_blank())
#+end_src

#+RESULTS:
[[file:imgs/sankey_open_data.png]]

** code and versioning
#+begin_src R :results output graphics file :file imgs/sankey_open_code.png :width 800
  dat |>
    separate_rows(`Skip Code`, sep = ",") |>
    separate_rows(`Versioning`, sep = ",") |>
    make_long(`Skip Code`, `Versioning`) |>
    ggplot(aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node))) +
    geom_sankey(flow.alpha = 0.6) +
    geom_sankey_text(aes(label = node), hjust = 0) +
    theme_sankey() +
    theme(legend.pos = "none", axis.title.x = element_blank())
#+end_src

#+RESULTS:
[[file:imgs/sankey_open_code.png]]

** FAIR and storage, grouped by level
#+begin_src R :results output graphics file :file imgs/sankey_FAIR_data.png :width 800
  dat |>
    separate_rows(`Publication location`, sep = ",") |>
    separate_rows(`Code License`, sep = ",") |>
    separate_rows(`Storage`, sep = ",") |>
    make_long(`FAIR Application`, `Storage`, Contact) |>
    ggplot(aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node))) +
    geom_sankey(flow.alpha = 0.6) +
    geom_sankey_text(aes(label = node), hjust = 0) +
    theme_sankey() +
    theme(legend.pos = "none", axis.title.x = element_blank())
#+end_src

#+RESULTS:
[[file:imgs/sankey_FAIR_data.png]]

** FAIR and code + share location + code license + DOI by level
#+begin_src R :results output graphics file :file imgs/sankey_FAIR_code.png :width 800
  dat |>
    separate_rows(`Code License`, sep = ",") |>
    separate_rows(`Versioning`, sep = ",") |>
    separate_rows(`Publication location`, sep = ",") |>
    make_long(`FAIR Application`, `Skip Code`, `Publication location`, `Code License`, `Code DOI`, Contact) |>
    ggplot(aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node))) +
    geom_sankey(flow.alpha = 0.6) +
    geom_sankey_text(aes(label = node), size = 3.5, hjust = 0) +
    theme_sankey() +
    theme(legend.pos = "none", axis.title.x = element_blank())
#+end_src

#+RESULTS:
[[file:imgs/sankey_FAIR_code.png]]

* COMMENT try out alluvial
alluvial needs frequencies or numbers in the data
#+begin_src R

  dat |>
    ggplot(aes(axis1 = `Open Data Formats`, axis2 = `Conversion`, y = freq)) +
    geom_alluvial() +
    geom_stratum() +
    geom_text(stat = "stratum",
              aes(label = after_stat(stratum))) +
    scale_x_discrete(limits = c("Survey", "Response"),
                     expand = c(0.15, 0.05)) +
    theme_void()
#+end_src

#+RESULTS:
: Error in FUN(X[[i]], ...) : object 'freq' not found
